<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.js"></script>
    </head>
    <body>

        <canvas id='input_img' width=200 height=200></canvas>
        <canvas id='output_img' width=200 height=200></canvas>

        <script>

            function normalize(t) {
                return tf.sub(tf.div(t, 127.5), 1)
            }

            function unnormalize(t) {
                return tf.mul(tf.add(t, 1), 127.5)
            }

            const input_canvas = document.getElementById('input_img');
            const output_canvas = document.getElementById('output_img');

            tf.loadLayersModel("/model/model.json").then((model) => {
                console.log('loaded')
                console.log(model)

                // Load test image.
                
                const im = new Image()
                im.src = '/input.png';
                im.onload = () => {
                    const data = tf.browser.fromPixels(im, 3)
                    data.print()
                    console.log(data.shape)
                    tf.browser.toPixels(data, input_canvas);

                    // [256,256,3]

                    const processed = normalize(data);
                    processed.print()

                    // Convert to shape [1,256,256,3]
                    let batch = tf.expandDims(processed)

                    let pred = model.predict(batch);

                    // Convert to shape [256,256,3] and unnormalize
                    let out = unnormalize(tf.squeeze(pred, 0));

                    tf.browser.toPixels(tf.div(out, 255), output_canvas);
                }
            });
        </script>
    </body>
</html>
